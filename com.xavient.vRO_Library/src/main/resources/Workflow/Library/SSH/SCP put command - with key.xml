<?xml version="1.0" encoding="UTF-8"?>
<workflow xmlns="http://vmware.com/vco/workflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://vmware.com/vco/workflow http://vmware.com/vco/workflow/Workflow-v4.xsd" root-name="item2" object-name="Workflow:name=generic" id="cd8ad13e-3726-4ef9-be37-ae3d5a95af12" version="0.1.1" api-version="6.0.0" allowed-operations="vef" restartMode="1" resumeFromFailedMode="0">
  <display-name><![CDATA[SCP put command - with key]]></display-name>
  <description><![CDATA[Copies a file from vRO to a host using SCP put command over SFTP.]]></description>
  <position y="0.45454545454545325" x="5.0"></position>
  <input>
    <param name="hostName" type="string">
      <description><![CDATA[Hostname or IP address of the SSH host]]></description>
    </param>
    <param name="port" type="number">
      <description><![CDATA[Port]]></description>
    </param>
    <param name="username" type="string">
      <description><![CDATA[Username]]></description>
    </param>
    <param name="password" type="SecureString">
      <description><![CDATA[Password]]></description>
    </param>
    <param name="localFile" type="Path">
      <description><![CDATA[Local file (full path and filename) on the vCO server]]></description>
    </param>
    <param name="remoteFile" type="Path">
      <description><![CDATA[Remote file (full path and filename) on the host]]></description>
    </param>
    <param name="passwordAuthentication" type="boolean">
      <description><![CDATA[Sets authentication to password or key file]]></description>
    </param>
    <param name="path" type="Path">
      <description><![CDATA[Path to the private key]]></description>
    </param>
    <param name="passphrase" type="SecureString">
      <description><![CDATA[Private key pass-phrase]]></description>
    </param>
  </input>
  <attrib name="error" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
    <description><![CDATA[Error output]]></description>
  </attrib>
  <attrib name="errorMessage" type="string" read-only="false">
    <value encoded="n"><![CDATA[]]></value>
    <description><![CDATA[Error message]]></description>
  </attrib>
  <attrib name="cmdResult" type="number" read-only="false">
    <value encoded="n"><![CDATA[__NULL__]]></value>
    <description><![CDATA[Result of the command]]></description>
  </attrib>
  <attrib name="defaultKeyPairPath" type="Path" read-only="false">
    <value encoded="n"><![CDATA[/var/lib/vco/app-server/conf/vco_key]]></value>
    <description><![CDATA[Default path to the key file]]></description>
  </attrib>
  <workflow-item name="item1" out-name="item4" type="task">
    <display-name><![CDATA[Check for error]]></display-name>
    <script encoded="false"><![CDATA[if(error.equals("")){
	cmdResult = 0;
} else {
	cmdResult =-1;
	errorMessage = "SSHSCPGetFile: " + error;
	System.error("Failed to get file. Error: " + error);
}]]></script>
    <in-binding>
      <bind name="error" type="string" export-name="error"></bind>
    </in-binding>
    <out-binding>
      <bind name="errorMessage" type="string" export-name="errorMessage"></bind>
      <bind name="cmdResult" type="number" export-name="cmdResult"></bind>
    </out-binding>
    <position y="9.954545454545453" x="244.5"></position>
  </workflow-item>
  <workflow-item name="item3" type="end" end-mode="0">
    <position y="0.45454545454545325" x="564.5"></position>
  </workflow-item>
  <workflow-item name="item4" out-name="item3" type="condition" alt-out-name="item5" comparator="0">
    <display-name><![CDATA[Get successfull?]]></display-name>
    <script encoded="false"><![CDATA[//Generated by the system, cannot be edited
return (cmdResult >= 0.0) ;]]></script>
    <in-binding>
      <bind name="cmdResult" type="number" export-name="cmdResult"></bind>
    </in-binding>
    <condition name="cmdResult" type="number" comparator="5" label="null">0.0</condition>
    <position y="0.45454545454545325" x="384.5"></position>
  </workflow-item>
  <workflow-item name="item5" throw-bind-name="errorMessage" type="end" end-mode="1">
    <position y="45.40909090909091" x="424.5"></position>
  </workflow-item>
  <workflow-item name="item2" out-name="item1" type="task">
    <display-name><![CDATA[Scriptable task]]></display-name>
    <script encoded="false"><![CDATA[var session = null;
try {
	if (port) {
		session = new SSHSession(hostName, username, port);
	} else {
		System.log("A port value is not provided! Using default port 22");
		session = new SSHSession(hostName, username);
	}

	if (passwordAuthentication){
		System.log("Connecting with password");
	} else {
		if (path == null || path == ""){
			System.log("using default");
			path = defaultKeyPairPath;
		}
		System.log("Connecting with key pair (" + path + ")");
		password = passphrase;
	}

	session.connectWithPasswordOrIdentity(passwordAuthentication, password, path);
	System.log("Connected!");

	session.putFile(localFile,remoteFile);
	output = session.getOutput();
	error = session.getError();
	exitCode = session.exitCode;

	System.log("Output: '" + output + "'");
	System.log("Error: '" + error + "'");
	System.log("Exit code: '" + exitCode + "'");

} catch (e) {
	throw "Unable to execute command: " + e;
} finally {
	if (session) {
		session.disconnect();
	}
}
]]></script>
    <in-binding>
      <bind name="hostName" type="string" export-name="hostName"></bind>
      <bind name="port" type="number" export-name="port"></bind>
      <bind name="username" type="string" export-name="username"></bind>
      <bind name="password" type="SecureString" export-name="password"></bind>
      <bind name="localFile" type="Path" export-name="localFile"></bind>
      <bind name="remoteFile" type="Path" export-name="remoteFile"></bind>
      <bind name="passwordAuthentication" type="boolean" export-name="passwordAuthentication"></bind>
      <bind name="path" type="Path" export-name="path"></bind>
      <bind name="passphrase" type="SecureString" export-name="passphrase"></bind>
    </in-binding>
    <out-binding>
      <bind name="error" type="string" export-name="error"></bind>
    </out-binding>
    <position y="9.954545454545453" x="104.5"></position>
  </workflow-item>
  <presentation>
    <desc><![CDATA[Copies a file from a host to the VS-O server using SSH/SCP.]]></desc>
    <p-step>
      <title><![CDATA[SCP get]]></title>
      <p-group>
        <title><![CDATA[Host]]></title>
        <desc><![CDATA[Enter the source host information]]></desc>
        <p-param name="hostName">
          <desc><![CDATA[Hostname or IP address]]></desc>
          <p-qual kind="static" name="mandatory" type="boolean"><![CDATA[true]]></p-qual>
        </p-param>
        <p-param name="port">
          <desc><![CDATA[Port]]></desc>
          <p-qual kind="static" name="defaultValue" type="number"><![CDATA[22]]></p-qual>
          <p-qual kind="static" name="maxNumberValue" type="Number"><![CDATA[65535.0]]></p-qual>
          <p-qual kind="static" name="minNumberValue" type="Number"><![CDATA[0]]></p-qual>
        </p-param>
      </p-group>
      <p-group>
        <title><![CDATA[Auth]]></title>
        <p-param name="passwordAuthentication">
          <desc><![CDATA[Do you want to use password authentication? If you click No, key file authentication will be used.]]></desc>
        </p-param>
        <p-param name="username">
          <desc><![CDATA[Username]]></desc>
        </p-param>
        <p-param name="password">
          <desc><![CDATA[Password]]></desc>
          <p-qual kind="ognl" name="visible" type="boolean"><![CDATA[#passwordAuthentication]]></p-qual>
        </p-param>
        <p-param name="path">
          <desc><![CDATA[Path to the private key]]></desc>
          <p-qual kind="ognl" name="notVisible" type="boolean"><![CDATA[#passwordAuthentication]]></p-qual>
          <p-qual kind="ognl" name="defaultValue" type="Path"><![CDATA[#defaultKeyPairPath]]></p-qual>
        </p-param>
        <p-param name="passphrase">
          <desc><![CDATA[Private key pass-phrase]]></desc>
          <p-qual kind="ognl" name="notVisible" type="boolean"><![CDATA[#passwordAuthentication]]></p-qual>
        </p-param>
      </p-group>
      <p-group>
        <title><![CDATA[File]]></title>
        <desc><![CDATA[Enter the file information]]></desc>
        <p-param name="remoteFile">
          <desc><![CDATA[Remote file on the host (full path and filename)]]></desc>
        </p-param>
        <p-param name="localFile">
          <desc><![CDATA[Local file (full path and filename) on the vCO server. Make sure that js-file-io-rights.conf allows access to folder]]></desc>
        </p-param>
      </p-group>
    </p-step>
  </presentation>
</workflow>